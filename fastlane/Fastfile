# Shared Fastfile for Homecooked Games Unity iOS builds
#
# Imported by game repos via:
#   import_from_git(url: "https://github.com/Homecooked-Games-Git/devops-toolkit.git",
#                   branch: "v1", path: "fastlane/Fastfile")
#
# Configuration via environment variables (set by the reusable workflow):
#   FL_APP_IDENTIFIER      - iOS bundle identifier (required)
#   FL_XCODE_PROJECT_DIR   - path to Unity's Xcode export (default: "build/iOS/iOS")
#   FL_OUTPUT_IPA_NAME     - IPA filename (required)
#   FL_TEAM_ID             - Apple Developer Team ID (required)

default_platform(:ios)

def fl_config(key, default: nil)
  value = ENV[key] || default
  UI.user_error!("Missing required environment variable: #{key}") if value.nil? || value.empty?
  value
end

platform :ios do

  private_lane :setup_api_key do
    app_store_connect_api_key(
      key_id: fl_config("APP_STORE_CONNECT_API_KEY_KEY_ID"),
      issuer_id: fl_config("APP_STORE_CONNECT_API_KEY_ISSUER_ID"),
      key_content: fl_config("APP_STORE_CONNECT_API_KEY_KEY"),
      in_house: false
    )
  end

  desc "Sync code signing certificates and profiles via match"
  lane :sync_signing do
    api_key = setup_api_key

    keychain_password = ENV["MATCH_KEYCHAIN_PASSWORD"] || ""

    create_keychain(
      name: "fastlane_keychain",
      password: keychain_password,
      default_keychain: true,
      unlock: true,
      timeout: 3600
    )

    app_id = fl_config("FL_APP_IDENTIFIER")

    match(
      type: "appstore",
      app_identifier: app_id,
      api_key: api_key,
      readonly: true,
      keychain_name: "fastlane_keychain",
      keychain_password: keychain_password
    )
  end

  desc "Build iOS IPA from Unity Xcode export"
  lane :build do
    app_id      = fl_config("FL_APP_IDENTIFIER")
    xcode_dir   = fl_config("FL_XCODE_PROJECT_DIR", default: "build/iOS/iOS")
    output_name = fl_config("FL_OUTPUT_IPA_NAME")
    team        = fl_config("FL_TEAM_ID")

    cocoapods(
      podfile: "#{xcode_dir}/Podfile",
      try_repo_update_on_error: true
    )

    sync_signing

    profile_name = "match AppStore #{app_id}"

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "#{xcode_dir}/Unity-iPhone.xcodeproj",
      team_id: team,
      bundle_identifier: app_id,
      profile_name: profile_name,
      code_sign_identity: "Apple Distribution",
      targets: ["Unity-iPhone"]
    )

    build_app(
      workspace: "#{xcode_dir}/Unity-iPhone.xcworkspace",
      scheme: "Unity-iPhone",
      export_method: "app-store",
      output_directory: "#{xcode_dir}/output",
      output_name: output_name,
      clean: true,
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          app_id => profile_name
        }
      }
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    build

    api_key = setup_api_key

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end

end
