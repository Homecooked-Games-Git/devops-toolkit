# Shared Fastfile for Homecooked Games Unity iOS builds
#
# Imported by game repos via:
#   import_from_git(url: "https://github.com/Homecooked-Games-Git/devops-toolkit.git",
#                   branch: "v1", path: "fastlane/Fastfile")
#
# Per-game config is read from the project's fastlane/Matchfile:
#   app_identifier  (bundle id)
#
# The reusable workflow sets:
#   FL_GAME_NAME           - used for IPA filename
#   FL_XCODE_PROJECT_DIR   - path to Unity's Xcode export (default: "build/iOS/iOS")

default_platform(:ios)

TEAM_ID = "X3DPX6VLNN"

# Resolve app_identifier from Appfile first, then fall back to Matchfile
def resolve_app_identifier
  id = CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier)
  return id if id

  matchfile = File.join(FastlaneCore::FastlaneFolder.path || "fastlane", "Matchfile")
  content = File.read(matchfile) rescue ""
  m = content.match(/app_identifier\(\[?"([^"]+)"/)
  UI.user_error!("No app_identifier found in Appfile or Matchfile") unless m
  m[1]
end

platform :ios do

  private_lane :setup_api_key do
    app_store_connect_api_key(
      key_id: ENV.fetch("APP_STORE_CONNECT_API_KEY_KEY_ID"),
      issuer_id: ENV.fetch("APP_STORE_CONNECT_API_KEY_ISSUER_ID"),
      key_content: ENV.fetch("APP_STORE_CONNECT_API_KEY_KEY"),
      in_house: false
    )
  end

  desc "Sync code signing certificates and profiles via match"
  lane :sync_signing do
    api_key = setup_api_key

    keychain_password = ENV["MATCH_KEYCHAIN_PASSWORD"] || ""

    create_keychain(
      name: "fastlane_keychain",
      password: keychain_password,
      default_keychain: true,
      unlock: true,
      timeout: 3600
    )

    match(
      type: "appstore",
      app_identifier: resolve_app_identifier,
      api_key: api_key,
      readonly: true,
      keychain_name: "fastlane_keychain",
      keychain_password: keychain_password
    )
  end

  desc "Build iOS IPA from Unity Xcode export"
  lane :build do
    app_id      = resolve_app_identifier
    xcode_dir   = ENV["FL_XCODE_PROJECT_DIR"] || "build/iOS/iOS"
    game_name   = ENV.fetch("FL_GAME_NAME")

    cocoapods(
      podfile: "#{xcode_dir}/Podfile",
      try_repo_update_on_error: true
    )

    sync_signing

    profile_name = "match AppStore #{app_id}"

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "#{xcode_dir}/Unity-iPhone.xcodeproj",
      team_id: TEAM_ID,
      bundle_identifier: app_id,
      profile_name: profile_name,
      code_sign_identity: "Apple Distribution",
      targets: ["Unity-iPhone"]
    )

    build_app(
      workspace: "#{xcode_dir}/Unity-iPhone.xcworkspace",
      scheme: "Unity-iPhone",
      export_method: "app-store",
      output_directory: "#{xcode_dir}/output",
      output_name: "#{game_name}.ipa",
      clean: true,
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          app_id => profile_name
        }
      }
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    build

    api_key = setup_api_key

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end

end
