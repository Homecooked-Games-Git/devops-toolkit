name: Unity Build & Deploy

on:
  workflow_call:
    inputs:
      game_name:
        description: "Human-readable name (used in job/artifact names and IPA filename)"
        required: true
        type: string
      build_target:
        description: "Platform to build"
        required: false
        type: string
        default: "iOS"
      distribution:
        description: "Distribution target: None, TestFlight, Firebase"
        required: false
        type: string
        default: "None"
      xcode_project_dir:
        required: false
        type: string
        default: "build/iOS/iOS"
      devops_toolkit_ref:
        description: "Git ref of devops-toolkit for import_from_git"
        required: false
        type: string
        default: "main"
      unity_versioning:
        required: false
        type: string
        default: "None"
      android_app_bundle:
        description: "Build AAB instead of APK"
        required: false
        type: boolean
        default: false
      script_defines:
        description: "Extra scripting define symbols to append (semicolon-separated, e.g. DEV_MODE;EXTRA_LOGGING)"
        required: false
        type: string
        default: ""
      clean_build:
        description: "Delete Library cache before building"
        required: false
        type: boolean
        default: false

jobs:
  # ── iOS ──────────────────────────────────────────────
  build-ios:
    if: inputs.build_target == 'iOS'
    name: "Build iOS"
    runs-on: [self-hosted, macOS]

    env:
      PATH: /opt/homebrew/opt/ruby@3.3/bin:/opt/homebrew/lib/ruby/gems/3.3.0/bin:/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
      MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
      APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
      APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
      FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
          clean: false
          fetch-depth: 0

      - name: Clean Workspace Artifacts
        run: |
          if [ "${{ inputs.clean_build }}" = "true" ]; then
            echo "Clean build: removing Library cache"
            git clean -fdx
          else
            git clean -fdx --exclude=Library
          fi

      - name: Ensure Unity Editor Installed
        run: |
          UNITY_VERSION=$(sed -n 's/m_EditorVersion: //p' ProjectSettings/ProjectVersion.txt)
          CHANGESET=$(sed -n 's/m_EditorVersionWithRevision: .* (\(.*\))/\1/p' ProjectSettings/ProjectVersion.txt)
          echo "Project requires Unity ${UNITY_VERSION} (changeset: ${CHANGESET})"
          echo "UNITY_VERSION=${UNITY_VERSION}" >> "$GITHUB_ENV"
          echo "CHANGESET=${CHANGESET}" >> "$GITHUB_ENV"
          HUB="/Applications/Unity Hub.app/Contents/MacOS/Unity Hub"
          if "$HUB" -- --headless editors --installed 2>/dev/null | grep -q "${UNITY_VERSION}"; then
            echo "Unity ${UNITY_VERSION} is already installed."
          else
            ARCH="arm64"
            if [ "$(uname -m)" = "x86_64" ]; then ARCH="x86_64"; fi
            echo "Installing Unity ${UNITY_VERSION} (${ARCH})..."
            "$HUB" -- --headless install --version "${UNITY_VERSION}" --changeset "${CHANGESET}" --architecture "${ARCH}"
            echo "Editor installation complete."
          fi

      - name: Ensure iOS Module Installed
        run: |
          HUB="/Applications/Unity Hub.app/Contents/MacOS/Unity Hub"
          ARCH="arm64"
          if [ "$(uname -m)" = "x86_64" ]; then ARCH="x86_64"; fi
          echo "Ensuring iOS module is installed for Unity ${UNITY_VERSION}..."
          yes | "$HUB" -- --headless install-modules --version "${UNITY_VERSION}" --module ios --architecture "${ARCH}" || echo "Module already installed or no action needed."

      - name: Auto-increment Build Number
        run: |
          CURRENT=$(sed -n 's/.*iPhone: \([0-9]*\).*/\1/p' ProjectSettings/ProjectSettings.asset | head -1)
          BUILD_NUMBER=$(( CURRENT + ${{ github.run_number }} ))
          sed -i '' -E "s/(buildNumber:.*iPhone: )[0-9]+/\1${BUILD_NUMBER}/" ProjectSettings/ProjectSettings.asset
          echo "Build number: ${CURRENT} + ${{ github.run_number }} = ${BUILD_NUMBER}"

      - name: Append Script Defines
        if: inputs.script_defines != ''
        run: |
          DEFINES="${{ inputs.script_defines }}"
          sed -i '' -E "s/(    iPhone: .*)$/\1;${DEFINES}/" ProjectSettings/ProjectSettings.asset
          echo "Appended script defines: ${DEFINES}"

      - name: Build Xcode Project via GameCI
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          targetPlatform: iOS
          skipActivation: true
          allowDirtyBuild: true
          versioning: ${{ inputs.unity_versioning }}

      - name: Install Ruby Dependencies
        if: inputs.distribution != 'None'
        run: bundle install

      - name: Run Fastlane
        if: inputs.distribution != 'None'
        run: |
          case "${{ inputs.distribution }}" in
            TestFlight) LANE="ios beta" ;;
            Firebase)   LANE="ios firebase" ;;
          esac
          bundle exec fastlane ${LANE}
        env:
          FL_GAME_NAME: ${{ inputs.game_name }}
          FL_XCODE_PROJECT_DIR: ${{ inputs.xcode_project_dir }}
          FL_DEVOPS_TOOLKIT_REF: ${{ inputs.devops_toolkit_ref }}

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ inputs.game_name }}-iOS-Build"
          path: "${{ inputs.xcode_project_dir }}/output/${{ inputs.game_name }}.ipa"

  # ── Android ──────────────────────────────────────────
  build-android:
    if: inputs.build_target == 'Android'
    name: "Build Android"
    runs-on: [self-hosted, macOS]

    env:
      PATH: /opt/homebrew/opt/ruby@3.3/bin:/opt/homebrew/lib/ruby/gems/3.3.0/bin:/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
      FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
          clean: false
          fetch-depth: 0

      - name: Clean Workspace Artifacts
        run: |
          if [ "${{ inputs.clean_build }}" = "true" ]; then
            echo "Clean build: removing Library cache"
            git clean -fdx
          else
            git clean -fdx --exclude=Library
          fi

      - name: Ensure Unity Editor Installed
        run: |
          UNITY_VERSION=$(sed -n 's/m_EditorVersion: //p' ProjectSettings/ProjectVersion.txt)
          CHANGESET=$(sed -n 's/m_EditorVersionWithRevision: .* (\(.*\))/\1/p' ProjectSettings/ProjectVersion.txt)
          echo "Project requires Unity ${UNITY_VERSION} (changeset: ${CHANGESET})"
          echo "UNITY_VERSION=${UNITY_VERSION}" >> "$GITHUB_ENV"
          echo "CHANGESET=${CHANGESET}" >> "$GITHUB_ENV"
          HUB="/Applications/Unity Hub.app/Contents/MacOS/Unity Hub"
          if "$HUB" -- --headless editors --installed 2>/dev/null | grep -q "${UNITY_VERSION}"; then
            echo "Unity ${UNITY_VERSION} is already installed."
          else
            ARCH="arm64"
            if [ "$(uname -m)" = "x86_64" ]; then ARCH="x86_64"; fi
            echo "Installing Unity ${UNITY_VERSION} (${ARCH})..."
            "$HUB" -- --headless install --version "${UNITY_VERSION}" --changeset "${CHANGESET}" --architecture "${ARCH}"
            echo "Editor installation complete."
          fi

      - name: Ensure Android Module Installed
        run: |
          HUB="/Applications/Unity Hub.app/Contents/MacOS/Unity Hub"
          ARCH="arm64"
          if [ "$(uname -m)" = "x86_64" ]; then ARCH="x86_64"; fi
          echo "Ensuring Android module is installed for Unity ${UNITY_VERSION}..."
          yes | "$HUB" -- --headless install-modules --version "${UNITY_VERSION}" --module android --architecture "${ARCH}" || echo "Module already installed or no action needed."

      - name: Auto-increment Build Number
        run: |
          CURRENT=$(sed -n 's/.*AndroidBundleVersionCode: \([0-9]*\).*/\1/p' ProjectSettings/ProjectSettings.asset)
          BUILD_NUMBER=$(( CURRENT + ${{ github.run_number }} ))
          sed -i '' -E "s/(AndroidBundleVersionCode: )[0-9]+/\1${BUILD_NUMBER}/" ProjectSettings/ProjectSettings.asset
          echo "Build number: ${CURRENT} + ${{ github.run_number }} = ${BUILD_NUMBER}"

      - name: Append Script Defines
        if: inputs.script_defines != ''
        run: |
          DEFINES="${{ inputs.script_defines }}"
          sed -i '' -E "s/(    Android: .*)$/\1;${DEFINES}/" ProjectSettings/ProjectSettings.asset
          echo "Appended script defines: ${DEFINES}"

      - name: Build Android via GameCI
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          ANDROID_KEYSTORE_NAME: ${{ secrets.ANDROID_KEYSTORE_NAME }}
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASS: ${{ secrets.ANDROID_KEYSTORE_PASS }}
          ANDROID_KEYALIAS_NAME: ${{ secrets.ANDROID_KEYALIAS_NAME }}
          ANDROID_KEYALIAS_PASS: ${{ secrets.ANDROID_KEYALIAS_PASS }}
        with:
          targetPlatform: Android
          skipActivation: true
          allowDirtyBuild: true
          versioning: ${{ inputs.unity_versioning }}
          androidAppBundle: ${{ inputs.android_app_bundle }}

      - name: Install Ruby Dependencies
        if: inputs.distribution == 'Firebase'
        run: bundle install

      - name: Run Fastlane
        if: inputs.distribution == 'Firebase'
        run: bundle exec fastlane android firebase
        env:
          FL_GAME_NAME: ${{ inputs.game_name }}
          FL_DEVOPS_TOOLKIT_REF: ${{ inputs.devops_toolkit_ref }}

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ inputs.game_name }}-Android-Build"
          path: build/Android
